name: 'Project SEKAI PR Labeling'
description: 'Add random Project SEKAI character labels to pull requests'
author: 'Narumikr'

inputs:
  github-token:
    description: 'GitHub token for API access'
    required: true
    default: ${{ github.token }}

runs:
  using: 'composite'
  steps:
    - name: Create and add character label
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const fs = require('fs');
          const path = require('path');

          // Get action directory path
          const actionDir = process.env.GITHUB_ACTION_PATH;

          // Import constants file
          const constantsCode = fs.readFileSync(
            path.join(actionDir, 'prsk-yell-label.constants.js'),
            'utf8'
          );

          // Import logic file
          const logicCode = fs.readFileSync(
            path.join(actionDir, 'prsk-labeling-logic.js'),
            'utf8'
          );

          // Combine both files and remove export/import statements
          let combinedCode = constantsCode + '\n\n' + logicCode;

          // Delete import statements
          combinedCode = combinedCode.replace(/import\s+{[^}]+}\s+from\s+['"][^'"]+['"];?\n?/g, '');

          // Remove export statements and assign to globalThis
          combinedCode = combinedCode.replace(/export\s+const\s+(\w+)\s*=/g, 'globalThis.$1 =');
          combinedCode = combinedCode.replace(/export\s+function\s+(\w+)/g, 'globalThis.$1 = function $1');
          combinedCode = combinedCode.replace(/export\s+async\s+function\s+(\w+)/g, 'globalThis.$1 = async function $1');

          // Evaluate the combined code
          eval(combinedCode);

          // Exec main task
          if (typeof globalThis.handlePrLabeling === 'function') {
            await globalThis.handlePrLabeling(github, context);
          } else {
            throw new Error('handlePrLabeling is not defined. Available: ' + Object.keys(globalThis).filter(k => k.includes('handle')).join(', '));
          }